import { Request, Response } from "express";
import { PagoService } from "../services/pagoService";
import { validateIntegerId, validateIntegerFields } from "../utils/validationHelper";
import { extractToken } from "../utils/tokenExtractor";

/**
 * Controlador para gestión de pagos
 * Sigue patrón: Try-Catch en Capa de Controlador con Respuestas Estandarizadas
 */
export class PagoController {
  private pagoService: PagoService;

  constructor() {
    this.pagoService = new PagoService();
  }

  /**
   * CU39 - Listar pedidos por pagar
   * GET /api/pago/pedidos-por-pagar
   */
  listarPedidosPorPagar = async (req: Request, res: Response): Promise<void> => {
    try {
      const pedidos = await this.pagoService.listarPedidosPorPagar();

      res.status(200).json({
        success: true,
        message: "Lista de pedidos por pagar obtenida exitosamente",
        data: pedidos.map(p => ({
          idPedido: p.idPedido,
          idUsuario: p.idUsuario,
          total: p.total,
          estado: p.estado,
          canalVenta: p.canalVenta,
          fechaPedido: p.fechaPedido,
          direccionEntrega: p.direccionEntrega
        })),
        total: pedidos.length
      });

    } catch (error: any) {
      console.error("Error al listar pedidos por pagar:", error);
      res.status(500).json({
        success: false,
        message: "Error al obtener la lista de pedidos por pagar",
        error: error.message
      });
    }
  };

  /**
   * CU39/CU40 - Registrar pago de pedido
   * POST /api/pago/registrar/:idPedido
   * 
   * IMPORTANTE: Este endpoint hace TODO el proceso de finalización:
   * - Calcula precio final con promociones
   * - Obtiene dirección del cliente (si no se envía)
   * - Valida stock actual
   * - Reduce inventario
   * - Registra pago
   * - Cambia estado a 'pagado'
   * 
   * Body:
   * {
   *   "idMetodoPago": number (requerido),
   *   "direccionEntrega": string (opcional - se usa la del pedido si existe)
   * }
   */
  registrarPagoPedido = async (req: Request, res: Response): Promise<void> => {
    try {
      const { idPedido } = req.params;
      const { idMetodoPago, direccionEntrega } = req.body;
      const idUsuario = req.user!.id; // El middleware authenticateToken ya validó esto

      const idPedidoNumero = validateIntegerId(idPedido, "ID de pedido", res);
      if (!idPedidoNumero) return;

      if (!idMetodoPago) {
        res.status(400).json({
          success: false,
          message: "El campo 'idMetodoPago' es requerido"
        });
        return;
      }

      if (!validateIntegerFields({ idMetodoPago }, ['idMetodoPago'], res)) {
        return;
      }

      const accessToken = extractToken(req);
      const resultado = await this.pagoService.registrarPagoPedido(
        idPedidoNumero,
        idUsuario,
        idMetodoPago,
        direccionEntrega,
        accessToken
      );

      res.status(resultado.status).json(resultado.data || { success: false, message: resultado.message });
    } catch (error: any) {
      console.error("Error al registrar pago:", error);
      res.status(500).json({
        success: false,
        message: "Error al registrar el pago. Intente nuevamente",
        error: error.message
      });
    }
  };

  /**
   * CU40 - Listar métodos de pago disponibles
   * GET /api/pago/metodos-pago
   */
  listarMetodosPago = async (req: Request, res: Response): Promise<void> => {
    try {
      const metodos = await this.pagoService.listarMetodosPago();

      res.status(200).json({
        success: true,
        message: "Métodos de pago obtenidos exitosamente",
        data: metodos.map(m => ({
          idMetodoPago: m.idMetodo,
          nombre: m.nombre
        }))
      });

    } catch (error: any) {
      console.error("Error al listar métodos de pago:", error);
      res.status(500).json({
        success: false,
        message: "Error al obtener métodos de pago",
        error: error.message
      });
    }
  };

  /**
   * Crear método de pago
   * POST /api/payments/methods
   */
  crearMetodoPago = async (req: Request, res: Response): Promise<void> => {
    try {
      const { nombre } = req.body;

      if (!nombre || typeof nombre !== 'string' || nombre.trim() === '') {
        res.status(400).json({
          success: false,
          message: "El campo 'nombre' es requerido y debe ser un texto válido"
        });
        return;
      }

      const resultado = await this.pagoService.crearMetodoPago(nombre.trim());
      res.status(resultado.status).json(resultado.data || { success: false, message: resultado.message });
    } catch (error: any) {
      console.error("Error al crear método de pago:", error);
      res.status(500).json({
        success: false,
        message: "Error al crear el método de pago",
        error: error.message
      });
    }
  };

  /**
   * Obtener método de pago por ID
   * GET /api/payments/methods/:idMetodo
   */
  obtenerMetodoPagoPorId = async (req: Request, res: Response): Promise<void> => {
    try {
      const { idMetodo } = req.params;

      const idMetodoNumero = validateIntegerId(idMetodo, "ID de método de pago", res);
      if (!idMetodoNumero) return;

      const metodo = await this.pagoService.obtenerMetodoPagoPorId(idMetodoNumero);

      if (!metodo) {
        res.status(404).json({
          success: false,
          message: "Método de pago no encontrado"
        });
        return;
      }

      res.status(200).json({
        success: true,
        data: {
          idMetodoPago: metodo.idMetodo,
          nombre: metodo.nombre
        }
      });
    } catch (error: any) {
      console.error("Error al obtener método de pago:", error);
      res.status(500).json({
        success: false,
        message: "Error al obtener el método de pago",
        error: error.message
      });
    }
  };

  /**
   * Actualizar método de pago
   * PUT /api/payments/methods/:idMetodo
   */
  actualizarMetodoPago = async (req: Request, res: Response): Promise<void> => {
    try {
      const { idMetodo } = req.params;
      const { nombre } = req.body;

      const idMetodoNumero = validateIntegerId(idMetodo, "ID de método de pago", res);
      if (!idMetodoNumero) return;

      if (!nombre || typeof nombre !== 'string' || nombre.trim() === '') {
        res.status(400).json({
          success: false,
          message: "El campo 'nombre' es requerido y debe ser un texto válido"
        });
        return;
      }

      const resultado = await this.pagoService.actualizarMetodoPago(idMetodoNumero, nombre.trim());
      res.status(resultado.status).json(resultado.data || { success: false, message: resultado.message });
    } catch (error: any) {
      console.error("Error al actualizar método de pago:", error);
      res.status(500).json({
        success: false,
        message: "Error al actualizar el método de pago",
        error: error.message
      });
    }
  };

  /**
   * Eliminar método de pago
   * DELETE /api/payments/methods/:idMetodo
   */
  eliminarMetodoPago = async (req: Request, res: Response): Promise<void> => {
    try {
      const { idMetodo } = req.params;

      const idMetodoNumero = validateIntegerId(idMetodo, "ID de método de pago", res);
      if (!idMetodoNumero) return;

      const resultado = await this.pagoService.eliminarMetodoPago(idMetodoNumero);
      res.status(resultado.status).json(resultado.data || { success: false, message: resultado.message });
    } catch (error: any) {
      console.error("Error al eliminar método de pago:", error);
      res.status(500).json({
        success: false,
        message: "Error al eliminar el método de pago",
        error: error.message
      });
    }
  };

  /**
   * CU041 - Consultar historial de pagos
   * GET /api/pago/historial
   * 
   * Obtiene el historial de pagos con filtros opcionales
   * Query params: fechaInicio, fechaFin, idMetodoPago, estado
   */
  obtenerHistorialPagos = async (req: Request, res: Response): Promise<void> => {
    try {
      const { fechaInicio, fechaFin, idMetodoPago, estado } = req.query;

      const filtros: any = {};

      if (fechaInicio) {
        filtros.fechaInicio = new Date(fechaInicio as string);
      }

      if (fechaFin) {
        filtros.fechaFin = new Date(fechaFin as string);
      }

      if (idMetodoPago) {
        filtros.idMetodoPago = parseInt(idMetodoPago as string);
      }

      if (estado) {
        filtros.estado = estado as string;
      }

      const historial = await this.pagoService.obtenerHistorialPagos(filtros);

      res.status(200).json({
        success: true,
        message: "Historial de pagos obtenido exitosamente",
        data: historial,
        total: historial.length
      });

    } catch (error: any) {
      console.error("Error al obtener historial de pagos:", error);
      res.status(500).json({
        success: false,
        message: "Error al obtener el historial de pagos",
        error: error.message
      });
    }
  };

  /**
   * CU041 - Obtener detalle de un pago
   * GET /api/pago/:idPago
   * 
   * Obtiene la información detallada de un pago específico
   */
  obtenerDetallePago = async (req: Request, res: Response): Promise<void> => {
    try {
      const { idPago } = req.params;

      if (!idPago || isNaN(parseInt(idPago))) {
        res.status(400).json({
          success: false,
          message: "ID de pago inválido"
        });
        return;
      }

      const detalle = await this.pagoService.obtenerDetallePago(parseInt(idPago));

      res.status(200).json({
        success: true,
        message: "Detalle de pago obtenido exitosamente",
        data: detalle
      });

    } catch (error: any) {
      console.error("Error al obtener detalle de pago:", error);
      
      if (error.message === "Pago no encontrado") {
        res.status(404).json({
          success: false,
          message: error.message
        });
        return;
      }

      res.status(500).json({
        success: false,
        message: "Error al obtener el detalle del pago",
        error: error.message
      });
    }
  };

  /**
   * CU041 - Descargar comprobante de pago (PDF)
   * GET /api/pago/:idPago/comprobante
   * 
   * Descarga el PDF del comprobante de pago
   */
  descargarComprobante = async (req: Request, res: Response): Promise<void> => {
    try {
      const { idPago } = req.params;

      if (!idPago || isNaN(parseInt(idPago))) {
        res.status(400).json({
          success: false,
          message: "ID de pago inválido"
        });
        return;
      }

      const detalle = await this.pagoService.obtenerDetallePago(parseInt(idPago));

      if (!detalle.urlComprobante) {
        res.status(404).json({
          success: false,
          message: "El pago no tiene comprobante generado"
        });
        return;
      }

      const path = require('path');
      const fs = require('fs');
      
      const rutaArchivo = path.resolve(detalle.urlComprobante);

      if (!fs.existsSync(rutaArchivo)) {
        res.status(404).json({
          success: false,
          message: "Archivo de comprobante no encontrado"
        });
        return;
      }

      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader('Content-Disposition', `attachment; filename=recibo_${idPago}.pdf`);
      
      const fileStream = fs.createReadStream(rutaArchivo);
      fileStream.pipe(res);

    } catch (error: any) {
      console.error("Error al descargar comprobante:", error);
      res.status(500).json({
        success: false,
        message: "Error al descargar el comprobante",
        error: error.message
      });
    }
  };

  /**
   * Obtener todos los pagos (Solo administradores)
   * GET /api/payment/all
   * 
   * Obtiene la lista completa de todos los pagos en el sistema
   * Requiere: rol de administrador
   */
  obtenerTodosLosPagos = async (req: Request, res: Response): Promise<void> => {
    try {
      const todosPagos = await this.pagoService.obtenerTodosLosPagos();

      res.status(200).json({
        success: true,
        message: "Lista completa de pagos obtenida exitosamente",
        data: todosPagos,
        total: todosPagos.length
      });

    } catch (error: any) {
      console.error("Error al obtener todos los pagos:", error);
      res.status(500).json({
        success: false,
        message: "Error al obtener la lista completa de pagos",
        error: error.message
      });
    }
  };
}
